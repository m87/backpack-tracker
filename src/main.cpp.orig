#include <iostream>
#include <opencv2/opencv.hpp>
#include "preprocessor.h"
#include <string>
using namespace std;
using namespace cv;

int main(int argc, char *argv[])
{

    Preprocessor prep(argv[1]);

    Mat past;
    Mat now;

    namedWindow("capture", CV_WINDOW_AUTOSIZE);
    namedWindow("op", CV_WINDOW_AUTOSIZE);

    BackgroundSubtractorMOG2 fgbg(300,64,false);
    Mat out, out1; 
    prep.getFrame(out);
    prep.getFrame(out1);

    Mat element = getStructuringElement(0,Size(3,3),Point(1,1));
   Mat element1 = getStructuringElement(MORPH_RECT, Size(7, 7), Point(3,3) );   
    
    while(true){
        prep.getFrame(now);
        fgbg(now,past,-1);
       // threshold(past, out, 130,255,0);
        //dilate(past,out,element);    
        morphologyEx(past,out,CV_MOP_CLOSE,element1);


        vector< vector< Point > >contours;
        findContours(out,contours,CV_RETR_EXTERNAL, CV_CHAIN_APPROX_NONE);

        vector <Rect> output;
        vector< vector< Point> >::iterator itc= contours.begin();  
        HOGDescriptor hog;
        hog.setSVMDetector(HOGDescriptor::getDefaultPeopleDetector());
        while(itc!=contours.end()){
           
            Rect mr = boundingRect(Mat(*itc));

                Moments moment = moments(Mat(*itc));
                 double area = moment.m00;
                 if(area < 400) {++itc;continue;}

                 vector<Rect> found, found_filtered;
                         hog.detectMultiScale(img, found, 0, Size(8,8), Size(32,32), 1.05, 2);
                          
                                 size_t i, j;
                                         for (i=0; i<found.size(); i++)
                                         {
                                                         Rect r = found[i];
                                                                     for (j=0; j<found.size(); j++)
                                                                                         if (j!=i && (r & found[j])==r)
                                                                                                                 break;
                                                                                 if (j==found.size())
                                                                                                     found_filtered.push_back(r);
                                                                                         
                                         }
                                                 for (i=0; i<found_filtered.size(); i++)
                                                 {
                                                            Rect r = found_filtered[i];
                                                                        r.x += cvRound(r.width*0.1);
                                                                                r.width = cvRound(r.width*0.8);
                                                                                        r.y += cvRound(r.height*0.06);
                                                                                                r.height = cvRound(r.height*0.9);
                                                                                                        rectangle(img, r.tl(), r.br(), cv::Scalar(0,255,0), 2);
                                                                                                            
                                                 }

            rectangle(now,mr,CV_RGB(255,0,0));
            ++itc;
        }






        imshow("capture",now);
        imshow("op",out);
        if (waitKey(10) >=0 )
            break;


        past=now;
    }

    return 0;
}
